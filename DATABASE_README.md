# ğŸ° Casino CMS Database Documentation

## Overview

This document explains the database structure, logic, and data flow for the Casino CMS (Content Management System). The system uses **Supabase** (PostgreSQL) as the backend database with **Next.js API routes** as the middleware layer.

## ğŸ“Š Database Architecture

### Core Components
1. **Supabase PostgreSQL Database** - Main data storage
2. **Supabase Storage** - File/image storage with CDN
3. **Next.js API Routes** - Backend logic and data transformation
4. **Row Level Security (RLS)** - Access control and permissions

---

## ğŸ—ï¸ Database Schema

### 1. `casinos` Table

**Purpose**: Stores all casino information, rankings, and metadata.

```sql
CREATE TABLE casinos (
    id BIGINT PRIMARY KEY,                    -- Unique identifier
    name VARCHAR(255) NOT NULL,               -- Casino name
    logo VARCHAR(500) NOT NULL,               -- Logo image URL
    url VARCHAR(500) NOT NULL,                -- Casino website URL
    rank INTEGER NOT NULL DEFAULT 1,         -- Display ranking (1 = top)
    "rankClass" VARCHAR(50),                  -- CSS class for rank styling
    rating DECIMAL(3,1) NOT NULL DEFAULT 0.0,-- Rating out of 10
    stars INTEGER NOT NULL DEFAULT 0,        -- Star rating (1-5)
    "isNew" BOOLEAN DEFAULT FALSE,            -- New casino flag
    "hasVPN" BOOLEAN DEFAULT FALSE,           -- VPN support flag
    "vpnTooltip" VARCHAR(255),               -- VPN tooltip text
    "buttonText" VARCHAR(100),               -- CTA button text
    bonus JSONB NOT NULL DEFAULT '{}',       -- Bonus information (JSON)
    features JSONB NOT NULL DEFAULT '{}',    -- Casino features (JSON)
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### JSONB Structure Examples:

**`bonus` field:**
```json
{
  "percentage": "200%",
  "maxAmount": "â‚¬500",
  "promoCode": "WELCOME200",
  "wager": "25x",
  "freeSpins": "50",
  "verification": "ÎÎ‘Î™"
}
```

**`features` field:**
```json
{
  "quickWithdrawals": true,
  "withdrawalText": "INSTANT WITHDRAWALS"
}
```

### 2. `billboards` Table

**Purpose**: Manages homepage carousel slides and promotional content.

```sql
CREATE TABLE billboards (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    title VARCHAR(255) NOT NULL,             -- Main headline
    subtitle VARCHAR(500) NOT NULL,          -- Secondary headline
    description TEXT NOT NULL,               -- Detailed description
    "buttonText" VARCHAR(100) NOT NULL,      -- CTA button text
    "buttonUrl" VARCHAR(500) NOT NULL,       -- CTA button destination
    "backgroundImage" VARCHAR(500) NOT NULL, -- Background image URL
    "isActive" BOOLEAN DEFAULT TRUE,         -- Visibility flag
    "order" INTEGER NOT NULL DEFAULT 1,     -- Display order
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

---

## ğŸ”„ Data Flow Logic

### 1. Casino Management Flow

```
Frontend Admin Panel â†’ API Route â†’ Database â†’ Response â†’ UI Update
```

**Step-by-step process:**

1. **User Action**: Admin edits casino in `/admin` panel
2. **API Call**: Frontend sends PUT/POST to `/api/casinos`
3. **Data Validation**: API validates required fields
4. **Database Update**: Supabase updates `casinos` table
5. **Response**: API returns success/error status
6. **UI Update**: Frontend refreshes data and shows notification

### 2. Billboard Management Flow

```
Image Upload â†’ Storage â†’ Database â†’ Frontend Display
```

**Detailed flow:**

1. **Image Upload**: 
   - Admin uploads image via BillboardForm
   - File sent to `/api/upload-image`
   - Image stored in Supabase Storage "boards" bucket
   - Public URL returned

2. **Billboard Save**:
   - Form data + image URL sent to `/api/billboards`
   - Data validated and transformed
   - Stored in `billboards` table

3. **Frontend Display**:
   - Homepage loads billboards via `/api/billboards`
   - Only active billboards displayed
   - Sorted by `order` field

### 3. Ranking System Logic

The casino ranking system uses several mechanisms:

```javascript
// Automatic rank assignment
const updatedCasinos = casinos.map((casino, index) => ({
  ...casino,
  rank: index + 1,
  rankClass: getRankClass(index + 1) // Returns 'gold', 'silver', 'bronze', 'default'
}));
```

**Rank Classes:**
- `rank: 1` â†’ `rankClass: 'gold'` (Premium styling)
- `rank: 2-3` â†’ `rankClass: 'silver'` (High-tier styling)  
- `rank: 4-10` â†’ `rankClass: 'bronze'` (Mid-tier styling)
- `rank: 11+` â†’ `rankClass: 'default'` (Standard styling)

---

## ğŸ” Security & Permissions

### Row Level Security (RLS)

**Purpose**: Controls data access at the database level.

```sql
-- Enable RLS on tables
ALTER TABLE casinos ENABLE ROW LEVEL SECURITY;
ALTER TABLE billboards ENABLE ROW LEVEL SECURITY;

-- Allow all operations (can be restricted later)
CREATE POLICY "Allow all operations on casinos" ON casinos
    FOR ALL USING (true) WITH CHECK (true);

CREATE POLICY "Allow all operations on billboards" ON billboards
    FOR ALL USING (true) WITH CHECK (true);
```

**Note**: Currently set to allow all operations. In production, you might want to restrict based on user roles.

### Storage Security

```sql
-- Public access to images
CREATE POLICY "Allow public access to boards" ON storage.objects
FOR SELECT USING (bucket_id = 'boards');

-- Upload permissions
CREATE POLICY "Allow public uploads to boards" ON storage.objects
FOR INSERT WITH CHECK (bucket_id = 'boards');
```

---

## ğŸ—ƒï¸ Storage Structure

### Supabase Storage Buckets

1. **`casino-assets`** - Casino logos and related images
2. **`boards`** - Billboard background images

### File Organization

```
casino-assets/
â”œâ”€â”€ casino-logos/
â”‚   â”œâ”€â”€ 1702123456789-betway_logo.png
â”‚   â”œâ”€â”€ 1702123567890-888casino_logo.jpg
â”‚   â””â”€â”€ ...

boards/
â”œâ”€â”€ billboard-images/
â”‚   â”œâ”€â”€ 1702123678901-welcome_banner.jpg
â”‚   â”œâ”€â”€ 1702123789012-vip_promo.png
â”‚   â””â”€â”€ ...
```

**Naming Convention**: `{timestamp}-{sanitized_filename}.{extension}`

---

## ğŸ”„ Auto-Update Mechanisms

### 1. Timestamp Updates

```sql
-- Function to auto-update timestamps
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

-- Apply to tables
CREATE TRIGGER update_casinos_updated_at 
    BEFORE UPDATE ON casinos 
    FOR EACH ROW 
    EXECUTE FUNCTION update_updated_at_column();
```

### 2. Automatic ID Generation

```sql
-- Auto-incrementing primary keys
id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY
```

### 3. Rank Auto-Assignment

When casinos are reordered, ranks are automatically recalculated:

```javascript
const moveUp = (id) => {
  // Find casino and swap with the one above
  // Automatically update ranks for both casinos
  // Save to database with new ranking
};
```

---

## ğŸ“ˆ Performance Optimizations

### Database Indexes

```sql
-- Casino table indexes
CREATE INDEX idx_casinos_rank ON casinos(rank);        -- Fast ranking queries
CREATE INDEX idx_casinos_name ON casinos(name);        -- Search by name
CREATE INDEX idx_casinos_rating ON casinos(rating);    -- Filter by rating

-- Billboard table indexes  
CREATE INDEX idx_billboards_order ON billboards("order");   -- Order sorting
CREATE INDEX idx_billboards_active ON billboards("isActive"); -- Active filtering
```

### Query Optimization

**Frontend queries are optimized by:**
- Loading only active billboards: `WHERE "isActive" = true`
- Ordering by rank/order: `ORDER BY rank ASC` / `ORDER BY "order" ASC`
- Using proper indexes for fast retrieval

---

## ğŸ”„ Data Synchronization

### API Data Transformation

The system transforms data between frontend and database formats:

**Frontend Format** (camelCase):
```javascript
{
  id: 1,
  buttonText: "Visit Casino",
  isActive: true,
  backgroundImage: "https://..."
}
```

**Database Format** (PostgreSQL with quotes):
```sql
{
  id: 1,
  "buttonText": "Visit Casino", 
  "isActive": true,
  "backgroundImage": "https://..."
}
```

**Transformation Logic**:
```javascript
// API handles the mapping automatically
const mappedData = data.map(item => ({
  id: item.id,
  buttonText: item.buttonText,
  isActive: item.isActive,
  backgroundImage: item.backgroundImage
}));
```

---

## ğŸ§ª Development vs Production

### Development Setup
- Uses fallback data if Supabase not configured
- Detailed error logging and debugging
- Relaxed security policies

### Production Considerations
- Implement proper authentication
- Restrict RLS policies based on user roles
- Enable database backups
- Monitor storage usage
- Implement rate limiting

---

## ğŸš€ API Endpoints Logic

### `/api/casinos`
- **GET**: Returns all casinos sorted by rank
- **POST**: Saves casino array, recalculates ranks
- **Automatic**: Sorts by rank, assigns rank classes

### `/api/billboards`  
- **GET**: Returns active billboards sorted by order
- **POST**: Saves billboard array, validates data
- **Filtering**: Only returns `isActive: true` for frontend

### `/api/upload-image`
- **POST**: Handles file uploads to Supabase Storage
- **Logic**: Determines bucket based on `type` parameter
- **Returns**: Public URL for immediate use

---

## ğŸ” Debugging & Monitoring

### Common Issues & Solutions

1. **Upload Failures**:
   - Check bucket exists and is public
   - Verify storage policies are active
   - Ensure file size under limit (10MB)

2. **Database Connection Issues**:
   - Verify environment variables
   - Check Supabase project status
   - Validate connection string

3. **Data Not Appearing**:
   - Check RLS policies
   - Verify table structure matches code
   - Ensure triggers are active

### Useful Debug Queries

```sql
-- Check table contents
SELECT * FROM casinos ORDER BY rank;
SELECT * FROM billboards ORDER BY "order";

-- Verify triggers exist
SELECT * FROM information_schema.triggers 
WHERE trigger_name LIKE '%update%';

-- Check storage policies
SELECT * FROM storage.objects WHERE bucket_id IN ('casino-assets', 'boards');
```

---

## ğŸ¯ Best Practices

### Database Design
- âœ… Use appropriate data types (BIGINT for IDs, JSONB for complex data)
- âœ… Implement proper indexing for performance
- âœ… Use triggers for automatic updates
- âœ… Enable RLS for security

### API Design  
- âœ… Validate input data thoroughly
- âœ… Handle errors gracefully with meaningful messages
- âœ… Transform data between frontend/backend formats
- âœ… Implement proper HTTP status codes

### Storage Management
- âœ… Organize files in logical folder structures
- âœ… Use timestamped filenames to prevent conflicts
- âœ… Set appropriate file size limits
- âœ… Implement public access for displayed images

This database system provides a robust, scalable foundation for managing casino content with proper data integrity, security, and performance optimization. 